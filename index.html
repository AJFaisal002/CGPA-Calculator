<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CUET CGPA Calculator</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
        }

        .wrapper {
            max-width: 700px;
            width: 100%;
        }

        h1 {
            text-align: center;
            margin-bottom: 15px;
        }

        textarea {
            width: 100%;
            height: 160px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
            box-sizing: border-box;
            resize: vertical;
        }

        .btn-bar {
            margin: 10px 0 20px;
            text-align: right;
        }

        button {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 10px 18px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #005ec0;
        }

        /* Your popup-style card */
        .container {
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
        }

        h2 {
            font-size: 18px;
            color: #fff;
            background: linear-gradient(90deg, #007bff, #00c4ff);
            padding: 10px 15px;
            margin: 0;
            border-radius: 5px 5px 0 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .results {
            background: #fff;
            border-radius: 0 0 5px 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .semester {
            margin: 8px 0;
            font-size: 14px;
            color: #333;
            line-height: 1.5;
        }

        .semester strong {
            color: #007bff;
        }

        .cgpa-value {
            font-weight: bold;
            color: #28a745;
        }

        .additional-info {
            color: #666;
            font-size: 12px;
            margin-left: 5px;
        }

        .failed {
            color: #dc3545;
            font-style: italic;
        }

        .error {
            color: #dc3545;
            font-size: 14px;
            text-align: center;
        }

        .warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
        }

        .info {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 12px 0;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <h1>CUET CGPA Calculator</h1>

    <p class="info">
        Paste the marksheet table copied from CUET result page
        (<em>Course Code, Course Credit, Level-Term, Sessional, Result, Course type</em>),
        then click <strong>Calculate CGPA</strong>.
    </p>

    <textarea id="inputText" placeholder="Paste your marksheet text here..."></textarea>

    <div class="btn-bar">
        <button id="calcBtn">Calculate CGPA</button>
    </div>

    <div class="container">
        <h2>CUET CGPA Results</h2>
        <div class="warning">
            F grades and self-study courses are ignored in CGPA calculation
            (they are listed as notes below).
        </div>
        <div class="results" id="cgpaResults">
            <p class="info">Results will appear here after calculation.</p>
        </div>
    </div>
</div>

<script>
    // ======== Grade → Grade point mapping ========
    function getGradePoint(grade) {
        const gradePoints = {
            'A+': 4.0,
            'A': 3.75,
            'A-': 3.5,
            'B+': 3.25,
            'B': 3.0,
            'B-': 2.75,
            'C+': 2.5,
            'C': 2.25,
            'D': 2.0,
            'F': 0.0
        };
        return gradePoints[grade] ?? null;
    }

    // Convert "Level 1 - Term I" → "1st Semester", etc.
    function getSemesterKey(levelTerm) {
        if (!levelTerm) return 'Unknown Semester';

        const romanToInt = {
            'I': 1, 'II': 2, 'III': 3, 'IV': 4,
            'V': 5, 'VI': 6, 'VII': 7, 'VIII': 8
        };

        const match = levelTerm.match(/Level\s+(\d+)\s*-\s*Term\s+([0-9IVX]+)/i);
        if (!match) return 'Unknown Semester';

        const level = parseInt(match[1], 10);
        let termRaw = match[2].toUpperCase();

        let term = parseInt(termRaw, 10);
        if (isNaN(term)) {
            term = romanToInt[termRaw] || 1;
        }

        const semesterNumber = (level - 1) * 2 + term;

        let suffix = 'th';
        if (semesterNumber % 10 === 1 && semesterNumber !== 11) suffix = 'st';
        else if (semesterNumber % 10 === 2 && semesterNumber !== 12) suffix = 'nd';
        else if (semesterNumber % 10 === 3 && semesterNumber !== 13) suffix = 'rd';

        return `${semesterNumber}${suffix} Semester`;
    }

    // Parse pasted text into course rows
    function parseMarksheet(text) {
        const lines = text.split(/\r?\n/);
        const rows = [];

        for (let line of lines) {
            line = line.trim();
            if (!line) continue;

            // Skip header line
            if (line.toLowerCase().includes('course code') &&
                line.toLowerCase().includes('course credit')) {
                continue;
            }

            // Prefer TAB-separated
            let cells = line.split(/\t+/);
            if (cells.length < 5) {
                // Fallback to multiple spaces
                cells = line.split(/\s{2,}/);
            }
            if (cells.length < 5) continue;

            const courseCode = cells[0].trim();
            const credit = parseFloat(cells[1].trim());
            const levelTerm = cells[2].trim();
            const grade = cells[4].trim().toUpperCase();
            const courseType = (cells[5] || '').trim();

            if (!courseCode || isNaN(credit) || !grade) continue;

            rows.push({ courseCode, credit, levelTerm, grade, courseType });
        }

        return rows;
    }

    function calculateAndRender() {
        const text = document.getElementById('inputText').value;
        const resultsDiv = document.getElementById('cgpaResults');

        if (!text.trim()) {
            resultsDiv.innerHTML = '<p class="error">Please paste marksheet text first.</p>';
            return;
        }

        const rows = parseMarksheet(text);

        if (rows.length === 0) {
            resultsDiv.innerHTML = '<p class="error">No valid course rows found. Check the format.</p>';
            return;
        }

        // Data structure similar to your extension code
        const semesters = {};
        let totalCredits = 0;       // only regular courses
        let totalGradePoints = 0;   // only regular courses

        rows.forEach(row => {
            const { courseCode, credit, levelTerm, grade, courseType } = row;

            const semesterKey = getSemesterKey(levelTerm);
            if (!semesters[semesterKey]) {
                semesters[semesterKey] = {
                    credits: 0,
                    gradePoints: 0,
                    selfStudyCourses: [],
                    failedCourses: [],
                    regularCredits: 0,
                    regularGradePoints: 0
                };
            }

            // Handle F grade (tracked but not counted)
            if (grade === 'F') {
                semesters[semesterKey].failedCourses.push(courseCode);
                return;
            }

            const gradePoint = getGradePoint(grade);
            if (gradePoint === null) return; // unknown grade

            const courseGradePoints = gradePoint * credit;

            // Self-study vs regular
            if (courseType.toLowerCase() === 'self study') {
                semesters[semesterKey].selfStudyCourses.push(courseCode);
            } else {
                semesters[semesterKey].regularCredits += credit;
                semesters[semesterKey].regularGradePoints += courseGradePoints;

                totalCredits += credit;
                totalGradePoints += courseGradePoints;
            }

            // Totals including everything (for info only)
            semesters[semesterKey].credits += credit;
            semesters[semesterKey].gradePoints += courseGradePoints;
        });

        // Build HTML output
        let html = '';

        const semesterKeys = Object.keys(semesters).sort((a, b) => {
            const numA = parseInt(a.match(/\d+/)[0], 10);
            const numB = parseInt(b.match(/\d+/)[0], 10);
            return numA - numB;
        });

        semesterKeys.forEach(semester => {
            const semData = semesters[semester];
            const semCredits = semData.regularCredits;
            const semGradePoints = semData.regularGradePoints;

            const cgpa = semCredits > 0
                ? (semGradePoints / semCredits).toFixed(2)
                : 'N/A';

            let extras = [];

            if (semData.selfStudyCourses.length > 0) {
                extras.push(`Self-study: ${semData.selfStudyCourses.join(', ')}`);
            }
            if (semData.failedCourses.length > 0) {
                extras.push(`<span class="failed">Failed (ignored): ${semData.failedCourses.join(', ')}</span>`);
            }

            html += `<div class="semester">
                        <strong>${semester}:</strong>
                        <span class="cgpa-value">${cgpa}</span>
                        ${extras.length ? `<span class="additional-info">(${extras.join('; ')})</span>` : ''}
                     </div>`;
        });

        html += '<hr>';

        const overallCGPA = totalCredits > 0
            ? (totalGradePoints / totalCredits).toFixed(2)
            : 'N/A';

        html += `<div class="semester">
                    <strong>Overall CGPA:</strong>
                    <span class="cgpa-value">${overallCGPA}</span>
                 </div>`;

        resultsDiv.innerHTML = html;
    }

    document.getElementById('calcBtn').addEventListener('click', calculateAndRender);
</script>
</body>
</html>
